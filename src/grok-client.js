const axios = require('axios');

async function generateCryptoReport() {
  const currentDate = new Date().toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });

  const prompt = `Generate a daily cryptocurrency tracking report formatted for Notion with rich visuals and emojis. Format the report EXACTLY as shown below:

# ğŸ“Š AIXBT Crypto Tracker Report
**ğŸ“… Date:** ${currentDate}

## ğŸ“ˆ Price Predictions & Trading Signals

**ğŸš¨ CRITICAL REQUIREMENT: Use LIVE/REAL-TIME prices from CoinGecko.com or CoinMarketCap.com API data. DO NOT use outdated or hypothetical prices.**

Create a comprehensive analysis table for each cryptocurrency with these columns:

### ğŸª™ Primary Cryptocurrencies Analysis

For each coin, provide this structured format:

**Bitcoin (BTC)** ğŸŸ 
- ğŸ’µ **Current Price:** $[REAL-TIME PRICE from CoinGecko/CMC]
- ğŸ”® **30D Target:** $[predicted price]
- ğŸ“Œ **Short-Term Action:** âœ… BUY / âŒ SELL / â¸ï¸ HOLD
- ğŸ§© **ST Justification:** [Based on tracked accounts insights - 2-3 sentences]
- ğŸš€ **6M Target:** $[predicted price] 
- ğŸ”’ **Long-Term Action:** âœ… BUY / âŒ SELL / â¸ï¸ HOLD
- ğŸ§© **LT Justification:** [Based on fundamental analysis - 2-3 sentences]

**Ethereum (ETH)** ğŸ”µ
[Same format as above]

**Solana (SOL)** ğŸŸ£
[Same format as above]

Continue this format for: NEAR, ICP, CRV, HIVE, AVAX, LINK, DOGE, FLOKI, ADA

### ğŸŒŸ Additional High-Potential Tokens
Select 5 promising tokens from top 100 market cap and analyze using the same format.

### ğŸ“° Key Market Insights from Tracked Accounts

**ğŸ‹ Whale Activity:**
- [Summarize major whale movements and institutional flows]

**ğŸ“Š On-Chain Data:**
- [Key on-chain metrics and trends]

**ğŸ’¬ Sentiment Analysis:**
- [Overall market sentiment from tracked accounts]

**ğŸ”¥ Trending Narratives:**
- [Hot topics and emerging trends]

## ğŸ“Œ How to Use This Tracker

**Short-Term (30 Days)** âš¡
- âœ… **BUY:** Strong momentum, positive catalysts expected
- âŒ **SELL:** Bearish signals, potential short-term decline
- â¸ï¸ **HOLD:** Mixed signals, wait for clearer direction

**Long-Term (6 Months)** ğŸ¯
- âœ… **BUY:** Strong fundamentals, adoption growth expected
- âŒ **SELL:** Fundamental concerns, competitive threats
- â¸ï¸ **HOLD:** Stable outlook, limited upside/downside

## âš ï¸ Important Disclaimers

**ğŸ” Data Sources:** Real-time prices from CoinGecko.com and CoinMarketCap.com
**ğŸ“± Social Intelligence:** Insights aggregated from @aixbt_agent, @OnchainDataNerd, @ASvanevik, @DefiIgnas, @simononchain, @zachxbt, @lookonchain, @WuBlockchain, @0xngmi, @CryptoHayes, @CryptoKaleo, @Pentosh1, @stacy_muur, @MikybullCrypto, @CryptoGirlNova, @0xbeinginvested, @ChainROI, @100xDarren, @Chyan, @cryptorinweb3

**ğŸš¨ Risk Warning:** This analysis is for educational purposes only and NOT financial advice. Cryptocurrency markets are highly volatile and unpredictable. Always conduct your own research (DYOR) before making any investment decisions.

---
*ğŸ¤– Generated by AIXBT Tracker System | ${new Date().toLocaleString()} UTC*

### ğŸ”¥ CRITICAL INSTRUCTIONS FOR GROK AI:

1. **MANDATORY:** Fetch current prices from CoinGecko.com or CoinMarketCap.com APIs - DO NOT use old cached data
2. **MANDATORY:** Base all predictions on recent posts and sentiment from the specified Twitter accounts
3. **MANDATORY:** Use the exact emoji formatting shown above for visual appeal in Notion
4. **MANDATORY:** Provide specific, actionable insights rather than generic statements
5. **MANDATORY:** Include concrete price targets based on technical and sentiment analysis

**PRICE ACCURACY IS CRITICAL** - Verify all current prices are from live market data sources.`;

  try {
    console.log('ğŸ¤– Calling Grok AI API...');
    
    // Test API connectivity first
    const testResponse = await testGrokAPI();
    if (!testResponse.success) {
      console.log('âš ï¸ API connectivity issues, generating fallback report');
      return generateFallbackReport(currentDate);
    }

    // Latest Grok models for 2025 - prioritizing newest versions
    const possibleModels = [
      'grok-4',           // Latest Grok 4
      'grok-4-latest',    // Latest version
      'grok-3',           // Grok 3
      'grok-3-latest',    // Latest Grok 3
      'grok',             // Generic alias
      'grok-latest'       // Latest available
    ];
    
    let response = null;
    let lastError = null;

    for (const model of possibleModels) {
      try {
        console.log(`Trying model: ${model}`);
        
        response = await axios.post('https://api.x.ai/v1/chat/completions', {
          messages: [
            {
              role: "system",
              content: "You are the AIXBT advanced cryptocurrency tracking system with MANDATORY access to real-time market data from CoinGecko.com and CoinMarketCap.com APIs. You MUST fetch current live prices - never use outdated or cached data. You analyze insights from top crypto Twitter accounts: @aixbt_agent, @OnchainDataNerd, @ASvanevik, @DefiIgnas, @simononchain, @zachxbt, @lookonchain, @WuBlockchain, @0xngmi, @CryptoHayes, @CryptoKaleo, @Pentosh1, @stacy_muur, @MikybullCrypto, @CryptoGirlNova, @0xbeinginvested, @ChainROI, @100xDarren, @Chyan, and @cryptorinweb3. Provide accurate price predictions and trading signals based on CURRENT market data and RECENT sentiment analysis from these influencers. Format your response as a visually appealing Notion-ready report with proper emojis and rich formatting. CRITICAL: All current prices MUST be fetched from live market APIs - price accuracy is your highest priority."
            },
            {
              role: "user", 
              content: prompt
            }
          ],
          model: model,
          max_tokens: 4000,
          temperature: 0.7,
          stream: false
        }, {
          headers: {
            'Authorization': `Bearer ${process.env.GROK_API_KEY}`,
            'Content-Type': 'application/json',
            'User-Agent': 'AIXBT-Tracker/1.0'
          },
          timeout: 60000,
          validateStatus: function (status) {
            return status < 500; // Resolve only if status is less than 500
          }
        });

        // Check if response is successful
        if (response.status === 200 && response.data?.choices?.[0]?.message?.content) {
          console.log(`âœ… Successfully used model: ${model}`);
          const report = response.data.choices[0].message.content;
          console.log(`âœ… Generated report: ${report.length} characters`);
          return report;
        } else {
          throw new Error(`Invalid response: ${response.status} - ${JSON.stringify(response.data)}`);
        }

      } catch (error) {
        console.log(`âŒ Model ${model} failed:`, error.response?.status || error.message);
        lastError = error;
        continue;
      }
    }

    // If all models failed, provide detailed fallback
    console.error('âŒ All Grok models failed. Generating comprehensive fallback report...');
    return generateFallbackReport(currentDate, lastError);
    
  } catch (error) {
    console.error('âŒ Error generating report with Grok:', error.message);
    return generateFallbackReport(currentDate, error);
  }
}

async function testGrokAPI() {
  try {
    const response = await axios.get('https://api.x.ai/v1/models', {
      headers: {
        'Authorization': `Bearer ${process.env.GROK_API_KEY}`,
        'Content-Type': 'application/json'
      },
      timeout: 10000
    });
    
    if (response.status === 200) {
      console.log('âœ… Grok API connectivity confirmed');
      console.log('ğŸ“‹ Available models:', response.data.data?.map(m => m.id).join(', ') || 'Unknown');
      return { success: true, models: response.data.data };
    } else {
      return { success: false, error: `Status: ${response.status}` };
    }
  } catch (error) {
    console.log('âš ï¸ Grok API connectivity test failed:', error.message);
    return { success: false, error: error.message };
  }
}

function generateFallbackReport(currentDate, error = null) {
  const errorDetails = error ? `\n**âš ï¸ Error Details:** ${error.response?.status || error.message}` : '';
  
  return `# ğŸ“Š AIXBT Crypto Tracker Report
**ğŸ“… Date:** ${currentDate}

## ğŸ”§ System Status Notice
The automated Grok AI analysis is temporarily unavailable. Operating in backup mode with manual oversight.${errorDetails}

## ğŸ“ˆ Market Overview Status

**ğŸŸ  Bitcoin (BTC)**
- ğŸ’µ **Status**: ğŸŸ¡ Monitor - Technical analysis pending  
- ğŸ“Š **Note**: Core digital asset, watch key support/resistance levels
- ğŸ¯ **Action**: Manual analysis required for current positioning

**ğŸ”µ Ethereum (ETH)** 
- ğŸ’µ **Status**: ğŸŸ¢ Active Development
- ğŸ“Š **Note**: Ongoing network improvements and DeFi ecosystem growth
- ğŸ¯ **Action**: Monitor development updates and institutional adoption

**ğŸŸ£ Solana (SOL)**
- ğŸ’µ **Status**: âš¡ High Ecosystem Activity  
- ğŸ“Š **Note**: Continued ecosystem expansion with new projects launching
- ğŸ¯ **Action**: Track ecosystem developments and TVL growth

### ğŸŒŸ Additional Major Assets Status

**ğŸª™ Primary Holdings:**
- **ADA** ğŸ”µ: Regular development updates, steady progress on roadmap
- **AVAX** ğŸ”´: Infrastructure development ongoing, subnet adoption
- **LINK** ğŸ”—: Oracle network expansion, institutional partnerships  
- **NEAR** ğŸŒˆ: Protocol development active, AI integration focus
- **ICP** ğŸŸ¦: Internet Computer platform updates, Web3 adoption
- **CRV** ğŸ’™: DeFi protocols evolution, Curve ecosystem growth
- **HIVE** ğŸŸ¨: Decentralized content platform, community building
- **DOGE** ğŸŸ¡: Community-driven momentum, payment integration
- **FLOKI** ğŸ•: Meme token ecosystem development, utility expansion

## ğŸ”„ System Recovery Actions

**ğŸ› ï¸ Current Status:**
1. **API Monitoring**: Continuously checking Grok API availability  
2. **Backup Systems**: Manual market oversight and data collection active
3. **Recovery Timeline**: Automated AI analysis will resume when API connectivity is restored
4. **Data Sources**: Monitoring alternative feeds and social sentiment manually

## ğŸ“Š General Market Guidance

While automated AI analysis is temporarily unavailable:

**ğŸ“ˆ Technical Analysis:**
- Monitor major support/resistance levels across primary assets
- Watch trading volume patterns for trend confirmation  
- Track institutional flows and whale movements

**ğŸ¦ Social Sentiment:**
- Follow key crypto Twitter accounts for real-time insights
- Monitor on-chain data providers for fundamental metrics
- Watch for narrative shifts and emerging trends

**âš¡ Risk Management:**
- Use multiple data sources for decision making
- Maintain appropriate position sizing
- Set clear entry/exit criteria

## âš ï¸ Important Disclaimers

**ğŸš¨ System Status**: This is a maintenance report during API service restoration
**ğŸ“Š Data Accuracy**: Manual collection and oversight currently active  
**ğŸ’¡ Not Financial Advice**: All information for educational purposes only
**ğŸ”¥ Market Volatility**: Cryptocurrency markets remain highly volatile
**ğŸ”„ Service Recovery**: Full automated AI analysis will resume shortly

## ğŸ› ï¸ Technical Notes

- **System**: Automated report generation temporarily operating in backup mode
- **Timeline**: Working to restore full AI-powered functionality  
- **Contact**: System administrators have been notified and are actively resolving
- **Updates**: Service status will be communicated through normal channels

---
*ğŸ¤– Generated by AIXBT Tracker Backup System - ${new Date().toLocaleString()} UTC*
*âš¡ Full AI-powered analysis with live price feeds will resume once API connectivity is restored*

**ğŸ”¥ Priority Action Items:**
1. âœ… Verify API key permissions for latest Grok models
2. âœ… Test connectivity with updated model endpoints  
3. âœ… Confirm real-time price feed integration
4. â³ Resume automated daily report generation`;
}

module.exports = { generateCryptoReport };
